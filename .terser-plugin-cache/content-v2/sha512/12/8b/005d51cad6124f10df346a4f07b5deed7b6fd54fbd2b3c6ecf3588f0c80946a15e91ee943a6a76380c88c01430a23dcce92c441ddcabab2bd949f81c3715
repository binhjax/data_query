{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[71],{5041:function(e,t,n){},5095:function(e,t,n){\"use strict\";n.r(t),n.d(t,\"default\",(function(){return S}));n(31);var a=n(0),o=n.n(a),i=n(2),s=n.n(i),l=n(1023),r=n(38),c=n(2449),u=n(179),h=n(554),d=n(62),p=n(13),m=n(250),y=n(1449),b=n(1330),v=n(1335),O=n(989),g=n(307),C=n(566),j=(n(5041),n(1));const f={name:s.a.string,annotationType:s.a.string,sourceType:s.a.string,color:s.a.string,opacity:s.a.string,style:s.a.string,width:s.a.number,showMarkers:s.a.bool,hideLine:s.a.bool,value:s.a.oneOfType([s.a.string,s.a.number]),overrides:s.a.object,show:s.a.bool,titleColumn:s.a.string,descriptionColumns:s.a.arrayOf(s.a.string),timeColumn:s.a.string,intervalEndColumn:s.a.string,vizType:s.a.string,error:s.a.string,colorScheme:s.a.string,addAnnotationLayer:s.a.func,removeAnnotationLayer:s.a.func,close:s.a.func},T={name:\"\",annotationType:O.e,sourceType:\"\",color:\"\",opacity:\"\",style:\"solid\",width:1,showMarkers:!1,hideLine:!1,overrides:{},colorScheme:\"d3Category10\",show:!0,titleColumn:\"\",descriptionColumns:[],timeColumn:\"\",intervalEndColumn:\"\",addAnnotationLayer:()=>{},removeAnnotationLayer:()=>{},close:()=>{}};class S extends o.a.PureComponent{constructor(e){super(e);const{name:t,annotationType:n,sourceType:a,color:o,opacity:i,style:s,width:l,showMarkers:r,hideLine:c,value:h,overrides:d,show:p,titleColumn:m,descriptionColumns:y,timeColumn:b,intervalEndColumn:v,vizType:O}=e;(\"since\"in d||\"until\"in d)&&(d.time_range=null,delete d.since,delete d.until);const g=Object(u.a)().get(O),C=(null==g?void 0:g.supportedAnnotationTypes)||[],j=C.includes(n)?n:C[0];this.state={name:t,annotationType:j,sourceType:a,value:h,overrides:d,show:p,titleColumn:m,descriptionColumns:y,timeColumn:b,intervalEndColumn:v,color:o||\"\",opacity:i,style:s,width:l,showMarkers:r,hideLine:c,isNew:!t,isLoadingOptions:!0,valueOptions:[]},this.submitAnnotation=this.submitAnnotation.bind(this),this.deleteAnnotation=this.deleteAnnotation.bind(this),this.applyAnnotation=this.applyAnnotation.bind(this),this.fetchOptions=this.fetchOptions.bind(this),this.handleAnnotationType=this.handleAnnotationType.bind(this),this.handleAnnotationSourceType=this.handleAnnotationSourceType.bind(this),this.handleValue=this.handleValue.bind(this),this.isValidForm=this.isValidForm.bind(this)}componentDidMount(){const{annotationType:e,sourceType:t,isLoadingOptions:n}=this.state;this.fetchOptions(e,t,n)}componentDidUpdate(e,t){t.sourceType!==this.state.sourceType&&this.fetchOptions(this.state.annotationType,this.state.sourceType,!0)}getSupportedSourceTypes(e){var t;const n=Object(u.a)().entries().filter(({value:t})=>t.canBeAnnotationType(e)).map(({key:e,value:t})=>({value:e,label:t.name}));return null!=(t=O.d[e])&&t.supportNativeSource&&n.unshift(O.b.NATIVE),n}isValidFormula(e,t){if(t===O.c.FORMULA)try{Object(c.z)(e).compile().evaluate({x:0})}catch(e){return!0}return!1}isValidForm(){const{name:e,annotationType:t,sourceType:n,value:a,timeColumn:o,intervalEndColumn:i}=this.state,s=[Object(h.a)(e),Object(h.a)(t),Object(h.a)(a)];return n!==O.a.NATIVE&&(t===O.c.EVENT&&s.push(Object(h.a)(o)),t===O.c.INTERVAL&&(s.push(Object(h.a)(o)),s.push(Object(h.a)(i)))),s.push(this.isValidFormula(a,t)),!s.filter(e=>e).length}handleAnnotationType(e){this.setState({annotationType:e,sourceType:null,value:null})}handleAnnotationSourceType(e){const{sourceType:t}=this.state;t!==e&&this.setState({sourceType:e,value:null,isLoadingOptions:!0})}handleValue(e){this.setState({value:e,descriptionColumns:null,intervalEndColumn:null,timeColumn:null,titleColumn:null,overrides:{time_range:null}})}fetchOptions(e,t,n){n&&(t===O.a.NATIVE?d.a.get({endpoint:\"/annotationlayermodelview/api/read?\"}).then(({json:e})=>{const t=e?e.result.map(e=>({value:e.id,label:e.name})):[];this.setState({isLoadingOptions:!1,valueOptions:t})}):Object(O.f)(t)?d.a.get({endpoint:\"/superset/user_slices\"}).then(({json:t})=>{const n=Object(u.a)();this.setState({isLoadingOptions:!1,valueOptions:t.filter(t=>{const a=n.get(t.viz_type);return a&&a.canBeAnnotationType(e)}).map(e=>({value:e.id,label:e.title,slice:e}))})}):this.setState({isLoadingOptions:!1,valueOptions:[]}))}deleteAnnotation(){this.props.removeAnnotationLayer(),this.props.close()}applyAnnotation(){if(this.isValidForm()){const e={};[\"name\",\"annotationType\",\"sourceType\",\"color\",\"opacity\",\"style\",\"width\",\"showMarkers\",\"hideLine\",\"value\",\"overrides\",\"show\",\"titleColumn\",\"descriptionColumns\",\"timeColumn\",\"intervalEndColumn\"].forEach(t=>{null!==this.state[t]&&(e[t]=this.state[t])}),\"\"===e.color&&(e.color=null),this.props.addAnnotationLayer(e),this.setState({isNew:!1})}}submitAnnotation(){this.applyAnnotation(),this.props.close()}renderOption(e){return Object(j.e)(\"span\",{className:\"optionWrapper\",title:e.label},e.label)}renderValueConfiguration(){const{annotationType:e,sourceType:t,value:n,valueOptions:a,isLoadingOptions:o}=this.state;let i=\"\",s=\"\";return Object(O.f)(t)?t===O.a.NATIVE?(i=\"Annotation layer\",s=\"Select the Annotation Layer you would like to use.\"):(i=Object(p.e)(\"Chart\"),s=`Use a pre defined Superset Chart as a source for annotations and overlays.\\n        your chart must be one of these visualization types:\\n        [${this.getSupportedSourceTypes(e).map(e=>e.label).join(\", \")}]`):e===O.c.FORMULA&&(i=\"Formula\",s=\"Expects a formula with depending time parameter 'x'\\n        in milliseconds since epoch. mathjs is used to evaluate the formulas.\\n        Example: '2x+5'\"),Object(O.f)(t)?Object(j.e)(y.a,{name:\"annotation-layer-value\",showHeader:!0,hovered:!0,description:s,label:i,placeholder:\"\",options:a,isLoading:o,value:n,onChange:this.handleValue,validationErrors:n?[]:[\"Mandatory\"],optionRenderer:this.renderOption}):e===O.c.FORMULA?Object(j.e)(b.a,{name:\"annotation-layer-value\",hovered:!0,showHeader:!0,description:s,label:i,placeholder:\"\",value:n,onChange:this.handleValue,validationErrors:this.isValidFormula(n,e)?[\"Bad formula.\"]:[]}):\"\"}renderSliceConfiguration(){const{annotationType:e,sourceType:t,value:n,valueOptions:a,overrides:o,titleColumn:i,timeColumn:s,intervalEndColumn:l,descriptionColumns:r}=this.state,{slice:c}=a.find(e=>e.value===n)||{};if(t!==O.a.NATIVE&&c){const t=(c.data.groupby||[]).concat(c.data.all_columns||[]).map(e=>({value:e,label:e})),n=c.data.include_time?[{value:\"__timestamp\",label:\"__timestamp\"}].concat(t):t;return Object(j.e)(\"div\",{style:{marginRight:\"2rem\"}},Object(j.e)(g.a,{isSelected:!0,title:Object(p.e)(\"Annotation Slice Configuration\"),info:Object(p.e)(\"This section allows you to configure how to use the slice\\n               to generate annotations.\")},(e===O.c.EVENT||e===O.c.INTERVAL)&&Object(j.e)(y.a,{hovered:!0,name:\"annotation-layer-time-column\",label:e===O.c.INTERVAL?\"Interval start column\":\"Event time column\",description:\"This column must contain date/time information.\",validationErrors:s?[]:[\"Mandatory\"],clearable:!1,options:n,value:s,onChange:e=>this.setState({timeColumn:e})}),e===O.c.INTERVAL&&Object(j.e)(y.a,{hovered:!0,name:\"annotation-layer-intervalEnd\",label:\"Interval End column\",description:\"This column must contain date/time information.\",validationErrors:l?[]:[\"Mandatory\"],options:t,value:l,onChange:e=>this.setState({intervalEndColumn:e})}),Object(j.e)(y.a,{hovered:!0,name:\"annotation-layer-title\",label:\"Title Column\",description:\"Pick a title for you annotation.\",options:[{value:\"\",label:\"None\"}].concat(t),value:i,onChange:e=>this.setState({titleColumn:e})}),e!==O.c.TIME_SERIES&&Object(j.e)(y.a,{hovered:!0,name:\"annotation-layer-title\",label:\"Description Columns\",description:\"Pick one or more columns that should be shown in the\\n                  annotation. If you don't select a column all of them will be shown.\",multi:!0,options:t,value:r,onChange:e=>this.setState({descriptionColumns:e})}),Object(j.e)(\"div\",{style:{marginTop:\"1rem\"}},Object(j.e)(v.a,{hovered:!0,name:\"annotation-override-time_range\",label:\"Override time range\",description:'This controls whether the \"time_range\" field from the current\\n                  view should be passed down to the chart containing the annotation data.',value:\"time_range\"in o,onChange:e=>{delete o.time_range,e?this.setState({overrides:{...o,time_range:null}}):this.setState({overrides:{...o}})}}),Object(j.e)(v.a,{hovered:!0,name:\"annotation-override-timegrain\",label:\"Override time grain\",description:\"This controls whether the time grain field from the current\\n                  view should be passed down to the chart containing the annotation data.\",value:\"time_grain_sqla\"in o,onChange:e=>{delete o.time_grain_sqla,delete o.granularity,e?this.setState({overrides:{...o,time_grain_sqla:null,granularity:null}}):this.setState({overrides:{...o}})}}),Object(j.e)(b.a,{hovered:!0,name:\"annotation-layer-timeshift\",label:\"Time Shift\",description:\"Time delta in natural language\\n                  (example:  24 hours, 7 days, 56 weeks, 365 days)\",placeholder:\"\",value:o.time_shift,onChange:e=>this.setState({overrides:{...o,time_shift:e}})}))))}return\"\"}renderDisplayConfiguration(){const{color:e,opacity:t,style:n,width:a,showMarkers:o,hideLine:i,annotationType:s}=this.state,c=Object(m.a)().get(this.props.colorScheme).colors.concat();return e&&\"\"!==e&&!c.find(t=>t.toLowerCase()===e.toLowerCase())&&c.push(e),Object(j.e)(g.a,{isSelected:!0,title:Object(p.e)(\"Display configuration\"),info:Object(p.e)(\"Configure your how you overlay is displayed here.\")},Object(j.e)(y.a,{name:\"annotation-layer-stroke\",label:Object(p.e)(\"Style\"),options:[{value:\"solid\",label:\"Solid\"},{value:\"dashed\",label:\"Dashed\"},{value:\"longDashed\",label:\"Long dashed\"},{value:\"dotted\",label:\"Dotted\"}],value:n,clearable:!1,onChange:e=>this.setState({style:e})}),Object(j.e)(y.a,{name:\"annotation-layer-opacity\",label:Object(p.e)(\"Opacity\"),options:[{value:\"\",label:\"Solid\"},{value:\"opacityLow\",label:\"0.2\"},{value:\"opacityMedium\",label:\"0.5\"},{value:\"opacityHigh\",label:\"0.8\"}],value:t,onChange:e=>this.setState({opacity:e})}),Object(j.e)(\"div\",null,Object(j.e)(C.a,{label:Object(p.e)(\"Color\")}),Object(j.e)(\"div\",{style:{display:\"flex\",flexDirection:\"column\"}},Object(j.e)(l.a,{color:e,colors:c,onChangeComplete:e=>this.setState({color:e.hex})}),Object(j.e)(r.a,{style:{marginTop:\"0.5rem\",marginBottom:\"0.5rem\"},buttonStyle:\"\"===e?\"success\":\"default\",buttonSize:\"xsmall\",onClick:()=>this.setState({color:\"\"})},\"Automatic Color\"))),Object(j.e)(b.a,{name:\"annotation-layer-stroke-width\",label:Object(p.e)(\"Line width\"),isInt:!0,value:a,onChange:e=>this.setState({width:e})}),s===O.c.TIME_SERIES&&Object(j.e)(v.a,{hovered:!0,name:\"annotation-layer-show-markers\",label:\"Show Markers\",description:\"Shows or hides markers for the time series\",value:o,onChange:e=>this.setState({showMarkers:e})}),s===O.c.TIME_SERIES&&Object(j.e)(v.a,{hovered:!0,name:\"annotation-layer-hide-line\",label:\"Hide Line\",description:\"Hides the Line for the time series\",value:i,onChange:e=>this.setState({hideLine:e})}))}render(){const{isNew:e,name:t,annotationType:n,sourceType:a,show:i}=this.state,s=this.isValidForm(),l=Object(u.a)().get(this.props.vizType),c=l?l.supportedAnnotationTypes.map(e=>O.d[e]):[],h=this.getSupportedSourceTypes(n);return Object(j.e)(o.a.Fragment,null,this.props.error&&Object(j.e)(\"span\",{style:{color:\"red\"}},\"ERROR: \",this.props.error),Object(j.e)(\"div\",{style:{display:\"flex\",flexDirection:\"row\"}},Object(j.e)(\"div\",{style:{marginRight:\"2rem\"}},Object(j.e)(g.a,{isSelected:!0,title:Object(p.e)(\"Layer configuration\"),info:Object(p.e)(\"Configure the basics of your Annotation Layer.\")},Object(j.e)(b.a,{name:\"annotation-layer-name\",label:Object(p.e)(\"Name\"),placeholder:\"\",value:t,onChange:e=>this.setState({name:e}),validationErrors:t?[]:[Object(p.e)(\"Mandatory\")]}),Object(j.e)(v.a,{name:\"annotation-layer-hide\",label:Object(p.e)(\"Hide layer\"),value:!i,onChange:e=>this.setState({show:!e})}),Object(j.e)(y.a,{hovered:!0,description:Object(p.e)(\"Choose the annotation layer type\"),label:Object(p.e)(\"Annotation layer type\"),name:\"annotation-layer-type\",clearable:!1,options:c,value:n,onChange:this.handleAnnotationType}),h.length>0&&Object(j.e)(y.a,{hovered:!0,description:\"Choose the source of your annotations\",label:\"Annotation Source\",name:\"annotation-source-type\",options:h,value:a,onChange:this.handleAnnotationSourceType,validationErrors:a?[]:[Object(p.e)(\"Mandatory\")]}),this.renderValueConfiguration())),this.renderSliceConfiguration(),this.renderDisplayConfiguration()),Object(j.e)(\"div\",{style:{display:\"flex\",justifyContent:\"space-between\"}},e?Object(j.e)(r.a,{buttonSize:\"small\",onClick:()=>this.props.close()},Object(p.e)(\"Cancel\")):Object(j.e)(r.a,{buttonSize:\"small\",onClick:this.deleteAnnotation},Object(p.e)(\"Remove\")),Object(j.e)(\"div\",null,Object(j.e)(r.a,{buttonSize:\"small\",disabled:!s,onClick:this.applyAnnotation},Object(p.e)(\"Apply\")),Object(j.e)(r.a,{buttonSize:\"small\",buttonStyle:\"primary\",disabled:!s,onClick:this.submitAnnotation},Object(p.e)(\"OK\")))))}}S.propTypes=f,S.defaultProps=T}}]);","extractedComments":[]}